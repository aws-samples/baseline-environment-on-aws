# v3 へのマイグレーションガイド

v2 から v3 への変更点の概要については、[v3 のリリースノート](https://github.com/aws-samples/baseline-environment-on-aws/releases/tag/v3.0.0)を参照ください

## 概要

v3 は上記のリリースノートにある通り、複数の Stack による構成から、シングル Stack 構成へ変更されました。

その結果、ガバナンスベースラインの設計方針・設定には変更がありませんが、リソースは再作成が必要になります。

AWS CloudTrail や AWS Config、AWS Security Hub といったログや検出結果といったデータを持つサービス群は、そのデータの取り扱いに考慮が必要です。
考慮が必要なサービスやデータについては、個別に記述していますので、参照ください。

## v2 の Stack 構成と生成されるリソース、その留意事項

| Standalone 版 | Multi-account 版 | Stack 名称                 | リソースの種類                             | 論理 ID                              | 再作成時の影響                                                                                                                                                                                                                                                                                                                        |
| :-----------: | :--------------: | -------------------------- | ------------------------------------------ | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|       ○       |        ○         | BLEAChatbotStack           | `aws_iam.Role`                             | `ChatbotRole`                        | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_chatbot.CfnSlackChannelConfiguration` | `ChatbotChannel`                     | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |                  | BLEAConfigCtGuardrailStack | `CfnInclude`                               | `ConfigCtGr`                         | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         | BLEAConfigRulesStack       | `aws_config.ManagedRule`                   | `BLEARuleDefaultSecurityGroupClosed` | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_iam.Role`                             | `RemoveSecGroupRemediationRole`      | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_config.CfnRemediationConfiguration`   | `RmDefaultSg`                        | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |                  | BLEAConfigStack            | `aws_iam.Role`                             | `ConfigRole`                         | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |                  |                            | `aws_config.CfnConfigurationRecorder`      | `ConfigRecorder`                     | Config Recorder が削除されたとしても、構成記録自体は削除されないため、再作成で問題ない。また、再度 Config Recorder が有効になることで、過去の構成記録にアクセス可能となる。 参考:[delete-configuration-recorder](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/configservice/delete-configuration-recorder.html) |
|       ○       |                  |                            | `aws_s3.Bucket`                            | `ConfigBucket`                       | 再作成で問題ない。ただし、v2 時に作成された Bucket は`DeletionPolicy`が`RETAIN`のため、Stack が削除されてもリソースは残る。 <br /> **Athena でクエリを実行する際は、マイグレーション前後で検索対象となる Bucket が異なるため、v2 用のデータソースと v3 用のデータソースの 2 つのデータソースが必要になる点は注意が必要**              |
|       ○       |                  |                            | `aws_config.CfnDeliveryChannel`            | `ConfigDeliveryChannel`              | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |                  | BLEAGuarddutyStack         | `aws_guardduty.CfnDetector`                | `GuardDutyDetector`                  |                                                                                                                                                                                                                                                                                                                                       |
|       ○       |        ○         | BLEAIamStack               | `aws_iam.ManagedP○licy`                    | `SysAdminPolicy`など                 | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_iam.Role`                             | `SysAdminRole`など                   | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_iam.Group`                            | `SysAdminGroup`など                  | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         | BLEASecurityAlarmStack     | `aws_sns.Topic`                            | `SecurityAlarmTopic`                 | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_events.Rule`                          | `BLEARuleConfigRules`など            | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_logs.MetricFilter`                    | `IAMPolicyChange`など                | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_cloudwatch.Alarm`                     | `IAMPolicyChangeAlarm`など           | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |                  | BLEASecurityHubStack       | `aws_iam.CfnServiceLinkedRole`             | `RoleForSecurityHub`                 | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |                  |                            | `aws_securityhub.CfnHub`                   | `SecurityHub`                        | 再作成で問題ない。ただし、SecurityHub を無効化した場合、90 日経過すると、既存の検出結果などが削除されてしまう。したがって、マイグレーションは 90 日以内に実施する必要がある。参考：[Security Hub を無効にする](https://docs.aws.amazon.com/ja_jp/securityhub/latest/userguide/securityhub-disable.html)                               |
|       ○       |        ○         | BLEATrailStack             | `aws_s3.Bucket`                            | `ArchiveLogsBucket`                  | -                                                                                                                                                                                                                                                                                                                                     |
|       ○       |        ○         |                            | `aws_s3.Bucket`                            | `CloudTrailBucket`                   | 再作成で問題ないが、**Athena でクエリを実行する際は、マイグレーション前後で検索対象となる Bucket が異なるため、v2 用のデータソースと v3 用のデータソースの 2 つのデータソースが必要になる点は注意が必要**                                                                                                                             |
|       ○       |        ○         |                            | `aws_kms.Key`                              | `CloudTrailKey`                      | 再作成で問題ないが、既存の暗号・復号対象のリソースのため、既存の`key`も残す必要がある                                                                                                                                                                                                                                                 |
|       ○       |        ○         |                            | `aws_logs.LogGroup`                        | `CloudTrailLogGroup`                 | 再作成で問題ないが、**Trail のログを検索する際は、マイグレーション前後で検索対象となる LogGroup が異なるため、注意が必要**                                                                                                                                                                                                            |
|       ○       |        ○         |                            | `aws_cloudtrail.Trail`                     | `CloudTrail`                         | -                                                                                                                                                                                                                                                                                                                                     |

## マイグレーション手順

1. BLEAv2 の Stack を全て削除する
   - ターミナルからの場合、v2 のソースコードを維持した状態で、`npm run aws-cdk destroy --all -c environment={環境識別子} --profile {profile}`を実行してください
   - マネジメントコンソールからの場合、CloudForamtion のコンソールへ遷移し、各 Stack を削除してください
2. BLEAv2 のソースコードを BLEAv3 へ更新する
   - github より、v3 のソースコードを pull するか、手動でマージしてください
3. BLEAv3 をデプロイする
   - [4-2. ガバナンスベースをデプロイする](../README_ja.md#4-2-ガバナンスベースをデプロイする)を参照し、v3 をデプロイしてください
   - デプロイ後にエラーが発生していなければ成功です
